Bootstrap: library
From: centos:7.6.1810

%labels
    author Moises Baltazar

%pre
# Before install (host)

%post
# After install (guest)
yum install -y python3 git vim
pip3 install pip requests argparse --upgrade
pip install -r /pipeline_tools/pipelines/requirements.txt

    # From prior script:
    #   (TODO: Not sure what is still useful)
    yum install -y wget tar gzip zip unzip which bzip2 bc hostname java tcsh libgomp libGLU libXmu gcc qt5-qtbase mesa-dri-drivers mesa-libGL-devel
	mkdir -p /NRG-data/NRG/intradb/archive
	mkdir -p /NRG-data/NRG/hcpdb/archive
	mkdir -p /NRG-data/NRG/hcpdb/build_ssd
	mkdir -p /usr/local/torque-6.1.2

	####	miniconda
	wget https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh -O /pipeline_tools/miniconda.sh
	bash /pipeline_tools/miniconda.sh -b -p /opt/miniconda
	rm /pipeline_tools/miniconda.sh
	export PATH=/opt/miniconda/bin:${PATH}
	conda create -y --name singlepython3 python=3
	source activate singlepython3
	conda install -y requests
	conda install -y pyqt

	yum install -y epel-release
	yum install -y python2-pip.noarch
	pip2 install --upgrade pip
	pip2 install requests[security]
	pip2 install argparse==1.4.0

	yum clean packages
	rm -rf /var/cache/yum/*

%test
# Test to run in order to ensure working environment
    exit 0

%runscript
# Script to run when executing environment
prunner --config=/pipeline_tools/pipelines/ "$@"

%files
# Files to copy from the host system.
./hcp-pipelines /pipeline_tools/pipelines
./HCPpipelinesRunUtils /pipeline_tools/HCPpipelinesRunUtils
./xnat_pbs_jobs /pipeline_tools/xnat_pbs_jobs
./xnat_utilities /export/HCP/xnat_utilities

%environment
# Environment variables
export PATH=/opt/miniconda/bin:/usr/local/torque-6.1.2/bin:/usr/local/torque-6.1.2/sbin:$HOME/bin:$PATH
source activate singlepython3
export HCP_RUN_UTILS=/pipeline_tools/HCPpipelinesRunUtils
export XNAT_PBS_JOBS=/pipeline_tools/xnat_pbs_jobs
export PYTHONPATH=${HCP_RUN_UTILS}/lib:${XNAT_PBS_JOBS}/lib
export XNAT_PBS_JOBS_PIPELINE_ENGINE=${XNAT_PBS_JOBS}/WorkingDirPut
export XNAT_UTILS_HOME=/export/HCP/xnat_utilities

